<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuki-Source BBS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #2fa1ff;
            --danger: #e55555;
            --light-gray: #f5f5f5;
            --gray: #cfcfcf;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --spacing: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--light-gray);
            color: #333;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        #menu {
            position: sticky;
            top: 0;
            margin: var(--spacing);
            padding: var(--spacing);
            background: var(--white);
            border-radius: 15px;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        #menu h4, .menu-section h5 {
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        #menu button, .menu-section button {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.3rem 0;
            transition: background 0.3s ease;
        }

        #menu button:hover, .menu-section button:hover {
            background: #1d8de0;
        }

        .menu-section {
            padding: 0.5rem 0;
            border-top: 1px solid var(--light-gray);
        }

        #shortcut_help {
            position: fixed;
            bottom: var(--spacing);
            left: var(--spacing);
            background: var(--gray);
            padding: var(--spacing);
            border-radius: 15px;
            box-shadow: var(--shadow);
            max-width: 90vw;
            overflow-x: auto;
        }

        #shortcut_help table {
            background: #efefef;
            border-collapse: collapse;
            width: 100%;
        }

        #shortcut_help th, #shortcut_help td {
            padding: 0.5rem;
            border: 1px solid #ddd;
        }

        #shortcut_help th {
            background: var(--primary);
            color: var(--white);
        }

        #pictureInPicture_display {
            position: fixed;
            bottom: var(--spacing);
            right: var(--spacing);
            background: var(--white);
            padding: 0.5rem;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        #pictureInPicture_display_iframe {
            width: 300px;
            height: 200px;
            border: none;
            border-radius: 10px;
        }

        #names_preview_div {
            position: fixed;
            top: 100px;
            left: var(--spacing);
            background: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 0.5rem;
        }

        #names_preview_div table {
            border-collapse: collapse;
            width: 100%;
        }

        #names_preview_div th, #names_preview_div td {
            padding: 0.5rem;
            border: 1px solid #ddd;
        }

        #names_preview_div th {
            background: var(--primary);
            color: var(--white);
        }

        label {
            display: block;
            margin: 0.5rem 0;
        }

        input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        select, input[type="text"], input[type="color"] {
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid var(--light-gray);
            width: 100%;
            max-width: 200px;
            margin: 0.3rem 0;
        }

        #main-content {
            padding: var(--spacing);
            max-width: 1200px;
            margin: 0 auto;
        }

        #post-form {
            background: var(--white);
            padding: var(--spacing);
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: var(--spacing);
        }

        #post-form input, #post-form select {
            display: block;
            width: 100%;
            margin: 0.5rem 0;
        }

        #post-form button {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            #menu { margin: 0.5rem; padding: 0.5rem; }
            #pictureInPicture_display_iframe { width: 200px; height: 150px; }
            #shortcut_help { max-width: 85vw; }
            #names_preview_div { top: 80px; }
        }

        @media (max-width: 480px) {
            #pictureInPicture_display_iframe { width: 150px; height: 100px; }
            #shortcut_help { font-size: 0.9rem; }
            select, input[type="text"], input[type="color"] { max-width: 100%; }
            #main-content { padding: 0.5rem; }
        }
    </style>
</head>
<body>
    <!-- Menu -->
    <div id="menu" class="hidden">
        <h4>Menu / メニュー</h4>
        <button onclick="this.parentElement.classList.add('hidden')">メニューを閉じる</button>
        
        <div id="settings_menu" class="menu-section">
            <h5>Settings / 設定</h5>
            <label><input type="checkbox" id="ajaxSend_checkbox"> Ajaxを使って送信する</label>
            <label><input type="checkbox" id="pictureInPicture_checkbox"> ピクチャインピクチャ</label>
            <label><input type="checkbox" id="keyboardshortcut_checkbox" checked> キーボードショートカットを利用</label>
            <label><input type="checkbox" id="enter_send_checkbox"> Enterキーで送信</label>
            <label>
                フォントを変更
                <select id="custom_font"></select>
            </label>
            <label><input type="checkbox" id="eazy_copy_checkbox"> メッセージコピー機能</label>
            <button onclick="document.getElementById('settings_menu_advanced').classList.toggle('hidden')">詳細設定</button>
            <div id="settings_menu_advanced" class="hidden">
                <label><input type="checkbox" id="messagesFilter_checkbox" checked> 投稿フィルター機能</label>
                <label><input type="checkbox" id="home_link_checkbox" checked> HomeLinkを表示</label>
            </div>
        </div>

        <div id="tools_menu" class="menu-section">
            <h5>Tools / ツール</h5>
            <label>
                <input id="add_replace_input" placeholder="数値文字参照に変換したい文字列">
                <input type="checkbox" id="all_replace_checkbox"> 全て変換
                <button onclick="replace_add_input()">変換してメッセージに追加</button>
            </label>
            <label>
                <input type="checkbox" onclick="namesPreviewCheck(this)"> 【新機能】名前プレビュー
                <button onclick="this.nextElementSibling.classList.toggle('hidden')">詳細設定</button>
                <div id="names_preview_checkbox_options" class="hidden">
                    <input placeholder="名前" value="名前">
                    <input type="color" value="#000000">
                    <input placeholder="ID" value="YukiBBS">
                    <select>
                        <option value="blue" selected>青ID</option>
                        <option value="darkorange">スピーカー</option>
                        <option value="red">マネージャー</option>
                        <option value="darkmagenta">モデレーター</option>
                        <option value="darkcyan">サミット</option>
                        <option value="red">運営</option>
                    </select>
                    <input placeholder="add（任意）">
                    <input placeholder="メッセージ" value="投稿内容">
                </div>
            </label>
        </div>
    </div>
    <button id="menu_open_button" onclick="document.getElementById('menu').classList.remove('hidden')">メニューを開く</button>

    <!-- Main Content -->
    <div id="main-content">
        <a href="/" id="home-link">ホームに戻る</a>
        <form id="post-form" onsubmit="return checkForm(event)">
            <input type="text" name="name" placeholder="名前" required>
            <input type="text" name="seed" placeholder="シード">
            <select id="channel" onchange="reloadmessages()">
                <option value="main">雑談</option>
                <option value="battle">バトルスタジアム</option>
            </select>
            <input type="text" name="message" placeholder="メッセージを入力" required>
            <label><input type="checkbox" id="filter"> フィルターを適用</label>
            <button type="submit">送信</button>
        </form>
        <div id="comments_num_info">更新待機中...</div>
    </div>

    <!-- Shortcut Help -->
    <div id="shortcut_help" class="hidden">
        <h3>キーボードショートカットヘルプ</h3>
        <table>
            <tr><th>キー</th><th>イベント</th></tr>
            <tr><td>Ctrl+Shift+R</td><td>投稿を更新</td></tr>
            <tr><td>Ctrl+Shift+H</td><td>Yuki Youtubeホームへ移動</td></tr>
            <tr><td>Ctrl+Shift+L</td><td>送信</td></tr>
            <tr><td>Ctrl+Shift+N(↑)</td><td>ページ最上部まで移動</td></tr>
            <tr><td>Ctrl+Shift+↓</td><td>ページ最下部まで移動</td></tr>
            <tr><td>Ctrl+Shift+M</td><td>メッセージ入力状態に変更</td></tr>
            <tr><td>Ctrl+Shift+J</td><td>チャンネルを変更</td></tr>
            <tr><td>Ctrl+Shift+B</td><td>シードを表示/非表示</td></tr>
            <tr><td>Ctrl+Shift+K</td><td>Googleを開く</td></tr>
            <tr><td>Ctrl+Shift+U</td><td>Ajax使用を切り替え</td></tr>
            <tr><td>Ctrl+Shift+C/V</td><td>チャンネルを雑談/バトルに変更</td></tr>
            <tr><td>Ctrl+Shift+Y</td><td>メニューを開閉</td></tr>
            <tr><td>Ctrl+Shift+/</td><td>ヘルプを表示</td></tr>
        </table>
    </div>

    <!-- Picture in Picture -->
    <div id="pictureInPicture_display" class="hidden">
        <iframe id="pictureInPicture_display_iframe"></iframe>
        <div>
            <input id="pictureInPicture_urlbar" placeholder="URLを入力" value="/watch?v=">
            <button onclick="document.getElementById('pictureInPicture_display_iframe').src = document.getElementById('pictureInPicture_urlbar').value; this.parentElement.previousElementSibling.classList.remove('hidden')">遷移</button>
        </div>
    </div>

    <!-- Names Preview -->
    <div id="names_preview_div" class="hidden">
        <table>
            <tr><th>No</th><th>名前</th><th>投稿</th></tr>
            <tr><td>0000</td><td></td><td></td></tr>
        </table>
    </div>

    <script defer>
        // Utility Functions
        const createElement = ({ tag = 'div', id = '', className = '', innerHTML = '' }) => {
            const elem = document.createElement(tag);
            if (id) elem.id = id;
            if (className) elem.className = className;
            if (innerHTML) elem.innerHTML = innerHTML;
            return elem;
        };

        const getParam = (key) => new URL(window.location.href).searchParams.get(key);

        const convertToNumericCharacterReference = (str) => [...str].map(char => `&#${char.codePointAt(0)};`).join('');

        const replaceBlankCharacters = (str) => /\s/.test(str) ? str.replace(/\s/g, match => convertToNumericCharacterReference(match)) : str;

        async function sha256(message) {
            const msgUint8 = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Main Logic
        const form = document.getElementById('post-form');
        const channel = document.getElementById('channel');
        const message = document.querySelector('[name="message"]');
        const name = document.querySelector('[name="name"]');
        const seed = document.querySelector('[name="seed"]');
        const verify = document.getElementById('filter');
        const homeLink = document.getElementById('home-link');

        const ajaxSendCheckbox = document.getElementById('ajaxSend_checkbox');
        const pictureInPictureCheckbox = document.getElementById('pictureInPicture_checkbox');
        const keyboardShortcutCheckbox = document.getElementById('keyboardshortcut_checkbox');
        const enterSendCheckbox = document.getElementById('enter_send_checkbox');
        const customFont = document.getElementById('custom_font');

        // Font Options
        const fonts = ["", "Arial", "Comic Sans MS", "Courier New", "Georgia", "Helvetica", "Impact", "Times New Roman", "Verdana", "Yu Gothic", "Meiryo"];
        fonts.forEach(font => {
            const option = document.createElement('option');
            option.value = font;
            option.textContent = font || 'Default';
            customFont.appendChild(option);
        });
        customFont.addEventListener('change', (e) => document.body.style.fontFamily = e.target.value);

        // Event Listeners
        pictureInPictureCheckbox.addEventListener('change', function() {
            const pipDisplay = document.getElementById('pictureInPicture_display');
            if (this.checked && ajaxSendCheckbox.checked) {
                reloadmessages();
                pipDisplay.classList.remove('hidden');
            } else {
                this.checked = false;
                pipDisplay.classList.add('hidden');
            }
        });

        message.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && enterSendCheckbox.checked) {
                e.preventDefault();
                if (this.value && !/^\s+$/.test(this.value) && checkForm(e)) {
                    if (ajaxSendCheckbox.checked) sendAjaxMessage();
                    else form.submit();
                }
            }
        });

        document.addEventListener('keydown', (e) => {
            if (!keyboardShortcutCheckbox.checked || !(e.ctrlKey || e.metaKey) || !e.shiftKey) return;
            e.preventDefault();
            switch (e.code) {
                case 'KeyM': message.focus(); break;
                case 'KeyN': case 'ArrowUp': window.scrollTo({ top: 0, behavior: 'smooth' }); break;
                case 'ArrowDown': window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); break;
                case 'KeyH': location.replace('/'); break;
                case 'KeyR': reloadmessages(); break;
                case 'KeyL': if (message.value && checkForm(e)) ajaxSendCheckbox.checked ? sendAjaxMessage() : form.submit(); break;
                case 'KeyJ': channel.value = channel.value === 'main' ? 'battle' : 'main'; reloadmessages(); break;
                case 'KeyB': seed.classList.toggle('hidden'); break;
                case 'KeyK': location.replace('https://www.google.com/'); break;
                case 'KeyU': ajaxSendCheckbox.checked = !ajaxSendCheckbox.checked; break;
                case 'KeyY': document.getElementById('menu').classList.toggle('hidden'); break;
                case 'Slash': case 'Period': document.getElementById('shortcut_help').classList.toggle('hidden'); break;
                case 'KeyC': channel.value = 'main'; reloadmessages(); break;
                case 'KeyV': channel.value = 'battle'; reloadmessages(); break;
            }
        });

        document.getElementById('home_link_checkbox').addEventListener('change', (e) => {
            homeLink.classList.toggle('hidden', !e.target.checked);
        });

        // Functions
        function checkForm(event) {
            if (message.value.includes(seed.value) || message.value.includes(getParam('seed'))) {
                console.log('Error: メッセージの中にシードが含まれています。');
                return false;
            }
            if (ajaxSendCheckbox.checked) {
                event.preventDefault();
                sendAjaxMessage();
                return false;
            }
            return true;
        }

        function sendAjaxMessage() {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", `/bbs/result?name=${encodeURIComponent(name.value)}&seed=${encodeURIComponent(seed.value)}&channel=${channel.value}&verify=${verify.checked}&message=${encodeURIComponent(message.value)}`);
            xhr.send();
            message.value = '';
            reloadmessages();
        }

        function reloadmessages() {
            console.log('Messages reloaded'); // 実際の更新ロジックをここに
        }

        function replace_add_input() {
            const input = document.getElementById('add_replace_input');
            const all = document.getElementById('all_replace_checkbox').checked;
            message.value += all ? convertToNumericCharacterReference(input.value) : replaceBlankCharacters(input.value);
            input.value = '';
        }

        function namesPreviewCheck(checkbox) {
            document.getElementById('names_preview_div').classList.toggle('hidden', !checkbox.checked);
        }
    </script>
</body>
</html>
